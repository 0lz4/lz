<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProjectTest ‚Äî mini‚Äëapplication</title>
  <!-- Telegram WebApp SDK will be ignored in a normal browser, but works in Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b1a3a; /* deep blue */
      --card:#102753;
      --muted:#6e7ea8;
      --text:#e9ecf6;
      --accent:#b66dff; /* purple CTA */
      --ok:#2ecc71;
      --warn:#ff5a5a;
      --outline:#3b5fb7;
      --chip:#0f1f44;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text); background:radial-gradient(1200px 600px at 50% -20%, #173572 0%, #0b1a3a 55%, #07112a 100%);
    }
    .app{max-width:980px;margin:0 auto;padding:12px 12px 120px}
    header{display:flex; align-items:center; gap:8px; position:sticky; top:0; z-index:5; backdrop-filter: blur(8px); background:rgba(7,17,42,.6); padding:8px 4px}
    header h1{font-size:16px; font-weight:700; margin:0; opacity:.9}
    header .spacer{flex:1}
    .icon-btn{width:36px;height:36px;display:grid;place-items:center;border-radius:12px;background:var(--chip);border:1px solid #203463;cursor:pointer}
    .badge{position:absolute; top:-4px; right:-4px; background:#fff; color:#000; font-size:11px; padding:0 6px; border-radius:999px;}

    .search-row{display:flex; gap:8px; margin:12px 0}
    .search{flex:1; background:var(--card); border:1px solid #1c356c; border-radius:12px; padding:10px 12px; color:var(--text)}
    .pill-row{display:flex; gap:8px; overflow:auto; padding-bottom:6px;}
    .pill{padding:8px 12px; border-radius:999px; background:var(--chip); border:1px solid #203463; white-space:nowrap; cursor:pointer; font-weight:600; font-size:13px}
    .pill.active{outline:2px solid var(--outline);}

    .filters{display:flex; align-items:center; gap:10px; margin:10px 0}
    .filter-card{background:var(--card); border:1px solid #1c356c; border-radius:var(--radius); padding:12px; display:none;}
    .filter-card.open{display:block}
    .filter-row{display:flex; gap:8px; flex-wrap:wrap}
    select, .tag{background:#0c1d44; border:1px solid #21407d; color:var(--text); border-radius:10px; padding:8px 10px}
    .tag{cursor:pointer}
    .tag.active{outline:2px solid var(--outline)}
    .apply{margin-top:10px; width:100%; padding:10px; background:var(--accent); border:none; color:#fff; border-radius:12px; font-weight:700; cursor:pointer}

    .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    @media (min-width:740px){ .grid{grid-template-columns:repeat(3,1fr);} }
    .card{background:var(--card); border:1px solid #1c356c; border-radius:var(--radius); overflow:hidden; cursor:pointer}
    .img{aspect-ratio: 4/3; background:#0d1d3f; display:grid; place-items:center}
    .img img{max-width:100%; max-height:100%}
    .card .body{padding:10px}
    .name{font-weight:800; font-size:15px; margin:0 0 4px 0}
    .desc{color:var(--muted); font-size:12px; margin:0 0 6px}
    .meta{display:flex; gap:6px; font-size:12px; color:#a9b7da}

    /* Modal */
    dialog{border:none; padding:0; width:min(560px, 96%); background:#0b1a3aAA}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .sheet{background:#0e2a63; border:1px solid #234592; border-radius:18px; overflow:hidden}
    .sheet .hero{background:#0d1d3f; display:grid; place-items:center}
    .sheet .hero img{max-width:100%; max-height:260px}
    .sheet .content{padding:14px}
    .title-row{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .title{font-size:18px; font-weight:800; margin:0}
    .x{background:transparent;color:#fff; border:none; font-size:22px; cursor:pointer}

    .options{display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin:10px 0}
    .opt{border:1.5px solid #294ea5; background:#0f2250; padding:10px; border-radius:14px;}
    .opt.disabled{opacity:.6}
    .opt.active{outline:2px solid var(--outline)}
    .opt .w{font-weight:800}
    .opt .p{font-size:13px; opacity:.85}
    .opt .s{font-size:11px; margin-top:4px; color:var(--ok)}
    .opt .oos{color:var(--warn)}

    .qty-row{display:flex; align-items:center; gap:10px; margin:12px 0}
    .stepper{display:flex; align-items:center; gap:6px}
    .stepper button{width:34px; height:34px; border-radius:10px; border:1px solid #294ea5; background:#0f2250; color:#fff; font-size:18px}
    .stepper .v{min-width:40px; text-align:center; font-weight:700}

    .total{display:flex; align-items:center; justify-content:space-between; margin:8px 0; font-weight:800}
    .cta{width:100%; padding:12px 14px; background:var(--accent); border:none; color:#fff; border-radius:14px; font-weight:800; font-size:15px; cursor:pointer}

    /* MainButton space */
    .footer-spacer{height:70px}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <button id="menuBtn" class="icon-btn" title="Menu">‚ò∞</button>
      <h1>ProjectTest <small style="opacity:.6;font-weight:600">mini‚Äëapplication</small></h1>
      <div class="spacer"></div>
      <div style="position:relative">
        <button id="giftBtn" class="icon-btn" title="Rewards">üéÅ</button>
      </div>
      <div style="position:relative">
        <button id="cartBtn" class="icon-btn" title="Panier">üõí</button>
        <span id="cartBadge" class="badge" style="display:none">0</span>
      </div>
    </header>

    <div class="search-row">
      <input id="search" class="search" placeholder="Rechercher des produits‚Ä¶" />
      <button id="filterToggle" class="icon-btn" title="Filtres">üîé</button>
    </div>

    <div class="pill-row" id="categories"></div>

    <div class="filters">
      <div class="filter-card" id="filterCard">
        <div class="filter-row">
          <label>
            <div style="font-size:12px; opacity:.8; margin-bottom:6px">Cat√©gorie</div>
            <select id="categorySelect"></select>
          </label>
          <div>
            <div style="font-size:12px; opacity:.8; margin-bottom:6px">Tags</div>
            <div id="tagRow" class="filter-row"></div>
          </div>
        </div>
        <button class="apply" id="applyFilters">Appliquer les filtres</button>
      </div>
    </div>

    <div id="grid" class="grid"></div>

    <div class="footer-spacer"></div>
  </div>

  <dialog id="productDialog">
    <div class="sheet">
      <div class="hero"><img id="dImg" alt="" /></div>
      <div class="content">
        <div class="title-row">
          <h3 class="title" id="dTitle"></h3>
          <button class="x" id="dClose">√ó</button>
        </div>
        <p id="dDesc" class="desc"></p>
        <div style="font-weight:700; margin-top:10px">S√©lectionner le poids</div>
        <div class="options" id="optGrid"></div>
        <div class="qty-row">
          <div style="font-weight:700">Quantit√©</div>
          <div class="stepper">
            <button id="minus">‚àí</button>
            <div class="v" id="qty">1</div>
            <button id="plus">+</button>
          </div>
        </div>
        <div class="total"><div>Total</div><div id="total">0‚Ç¨</div></div>
        <button class="cta" id="addToCart">Ajouter au panier</button>
      </div>
    </div>
  </dialog>

  <script>
  // --- Minimal data store ----------------------------------------------------
  const PRODUCTS = [
    {
      id: 'amnesia',
      name: "Amnesia d'Hollande üá≥üá±",
      desc: "Nouvelle arriv√©e de la frappe d'Hollande",
      category: 'CBD',
      tags:['Indica'],
      image: 'https://picsum.photos/seed/amnesia/600/400',
      variants: [
        {label:'5g', price:30, inStock:false},
        {label:'10g', price:90, inStock:true}
      ]
    },
    {
      id: 'purple', name:'Purple Haze üá≥üá±', desc:'Purple haze tout droit venu d\'Hollande. Sativa', category:'CBD', tags:['Sativa'], image:'https://picsum.photos/seed/purple/600/400',
      variants:[{label:'5g', price:28, inStock:true},{label:'10g', price:85, inStock:true}]
    },
    { id:'frozen', name:'Frozen Gummies', desc:'Bonbons CBD glac√©s', category:'FROZEN', tags:['Gourmand'], image:'https://picsum.photos/seed/frozen/600/400', variants:[{label:'Bo√Æte', price:25, inStock:true}]}
  ];

  const CATEGORIES = ['Tout','CBD','FROZEN'];
  const TAGS = ['Indica','Sativa','Gourmand'];

  // --- Telegram integration (safe in browser) -------------------------------
  const tg = window.Telegram?.WebApp ?? { initDataUnsafe:{}, MainButton:{show(){}, hide(){}, setText(){}} };
  tg.ready?.();
  tg.expand?.();

  // --- State ----------------------------------------------------------------
  const state = {
    category:'Tout',
    search:'',
    tags:new Set(),
    cart:[] // {id, name, variant, price, qty}
  };

  // --- UI helpers ------------------------------------------------------------
  const $ = s=>document.querySelector(s);
  const grid = $('#grid');
  const badge = $('#cartBadge');

  function renderCategories(){
    const row = $('#categories');
    row.innerHTML = '';
    CATEGORIES.forEach(cat=>{
      const b = document.createElement('button');
      b.className = 'pill'+(state.category===cat?' active':'');
      b.textContent = cat;
      b.onclick = ()=>{ state.category=cat; renderProducts(); updateCategorySelect(); };
      row.appendChild(b);
    });
  }

  function updateCategorySelect(){
    const sel = $('#categorySelect');
    sel.innerHTML = CATEGORIES.map(c=>`<option ${c===state.category?'selected':''}>${c}</option>`).join('');
  }

  function renderTagRow(){
    const row = $('#tagRow');
    row.innerHTML = '';
    TAGS.forEach(t=>{
      const el = document.createElement('div');
      el.className = 'tag'+(state.tags.has(t)?' active':'');
      el.textContent = t;
      el.onclick = ()=>{ state.tags.has(t)? state.tags.delete(t): state.tags.add(t); renderTagRow(); };
      row.appendChild(el);
    })
  }

  function productMatches(p){
    const byCat = state.category==='Tout' || p.category===state.category;
    const bySearch = !state.search || (p.name+" "+p.desc).toLowerCase().includes(state.search.toLowerCase());
    const byTags = state.tags.size===0 || [...state.tags].every(t=>p.tags.includes(t));
    return byCat && bySearch && byTags;
  }

  function renderProducts(){
    const items = PRODUCTS.filter(productMatches);
    grid.innerHTML = '';
    items.forEach(p=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="img"><img src="${p.image}" alt="${p.name}" /></div>
        <div class="body">
          <div class="name">${p.name}</div>
          <p class="desc">${p.desc}</p>
          <div class="meta"><span>${p.category}</span>${p.tags.map(t=>`<span>¬∑ ${t}</span>`).join('')}</div>
        </div>`;
      card.onclick = ()=> openProduct(p);
      grid.appendChild(card);
    })
  }

  function updateBadge(){
    const count = state.cart.reduce((n,i)=>n+i.qty,0);
    if(count>0){ badge.style.display='inline-block'; badge.textContent = count; }
    else{ badge.style.display='none'; }

    // Telegram MainButton shows subtotal
    const total = state.cart.reduce((s,i)=>s+i.price*i.qty,0);
    if(total>0){
      tg?.MainButton?.setText?.(`Payer ¬∑ ${total.toFixed(2)}‚Ç¨`);
      tg?.MainButton?.show?.();
    }else{
      tg?.MainButton?.hide?.();
    }
  }

  // --- Product dialog --------------------------------------------------------
  const dialog = $('#productDialog');
  let current = null; // {p, variantIndex, qty}

  function openProduct(p){
    current = {p, variantIndex: p.variants.findIndex(v=>v.inStock) ?? 0, qty:1};
    $('#dImg').src = p.image;
    $('#dTitle').textContent = p.name;
    $('#dDesc').textContent = p.desc;
    renderOptions();
    updateDialogTotals();
    dialog.showModal();
  }

  function renderOptions(){
    const box = $('#optGrid'); box.innerHTML='';
    current.p.variants.forEach((v,idx)=>{
      const el = document.createElement('div');
      el.className = 'opt'+(idx===current.variantIndex?' active':'')+(v.inStock?'':' disabled');
      el.innerHTML = `
        <div class="w">${v.label}</div>
        <div class="p">${v.price.toFixed(0)}‚Ç¨</div>
        <div class="s ${v.inStock? '': 'oos'}">${v.inStock? 'En stock' : 'Rupture de stock'}</div>`;
      el.onclick = ()=>{ if(!v.inStock) return; current.variantIndex = idx; renderOptions(); updateDialogTotals(); };
      box.appendChild(el);
    })
  }

  function updateDialogTotals(){
    const v = current.p.variants[current.variantIndex];
    $('#qty').textContent = current.qty;
    const total = v.price * current.qty;
    $('#total').textContent = total.toFixed(0)+ '‚Ç¨';
  }

  $('#plus').onclick = ()=>{ current.qty++; updateDialogTotals(); }
  $('#minus').onclick = ()=>{ current.qty = Math.max(1, current.qty-1); updateDialogTotals(); }
  $('#dClose').onclick = ()=> dialog.close();

  $('#addToCart').onclick = ()=>{
    const v = current.p.variants[current.variantIndex];
    if(!v.inStock) return;
    const key = `${current.p.id}-${v.label}`;
    const existing = state.cart.find(i=>i.key===key);
    if(existing) existing.qty += current.qty;
    else state.cart.push({key, id:current.p.id, name:current.p.name, variant:v.label, price:v.price, qty:current.qty});
    updateBadge();
    dialog.close();
    try{ tg.HapticFeedback?.impactOccurred?.('soft'); }catch{}
  }

  // --- Filters & search ------------------------------------------------------
  $('#search').addEventListener('input', e=>{ state.search = e.target.value; renderProducts(); });
  $('#filterToggle').onclick = ()=> $('#filterCard').classList.toggle('open');
  $('#applyFilters').onclick = ()=>{
    state.category = $('#categorySelect').value;
    renderCategories();
    $('#filterCard').classList.remove('open');
    renderProducts();
  }

  // --- Cart and checkout (demo only) ----------------------------------------
  $('#cartBtn').onclick = ()=>{
    if(state.cart.length===0){ alert('Votre panier est vide.'); return; }
    const lines = state.cart.map(i=>`${i.name} ${i.variant} √ó${i.qty} ‚Äî ${(i.price*i.qty).toFixed(2)}‚Ç¨`).join('\n');
    const total = state.cart.reduce((s,i)=>s+i.price*i.qty,0).toFixed(2);
    if(window.Telegram?.WebApp){
      Telegram.WebApp.showAlert(`Panier:\n\n${lines}\n\nTotal: ${total}‚Ç¨\n\n( d√©mo ‚Äî impl√©mentez votre paiement )`);
    }else{
      alert(`Panier:\n\n${lines}\n\nTotal: ${total}‚Ç¨\n\n( d√©mo ‚Äî impl√©mentez votre paiement )`);
    }
  }

  // MainButton tap (Telegram)
  if(tg?.MainButton){
    tg.onEvent?.('mainButtonClicked', ()=>{
      $('#cartBtn').click();
    });
  }

  // --- Init -----------------------------------------------------------------
  renderCategories();
  updateCategorySelect();
  renderTagRow();
  renderProducts();
  updateBadge();
  </script>
</body>
</html>